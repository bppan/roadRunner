Do("mod/ajax","lib/textarea-mention","ui/hover-tip","mod/template","dui:overlay","ui/alert",function(){var c=Ark.ajax,b=function(e){e=e.clone();e.find("[data-id]").each(function(f,g){g=$(g);g.text("@"+g.data("id"))});return e.text()},d=function(e){var n=e.find(".rebate-info");if(!n.length){return}var l=n.find('[name="share_with_referral_code"]'),j=n.find('[name="referral_code"]'),i=n.find(".another-rebate-way"),m=i.find(".show-rebate-link-btn"),h=i.find(".rebate-link-container"),p=i.find(".rebate-link"),k=n.find(".rebate-helper"),g=n.data("article-id"),o=$('<div class="hover-tip-container">'+k.data("tip-content")+"</div>");Ark.hoverTip(k,o,{left:k.width()+5});if(l.is(":checked")){f()}else{l.one("change",f)}function f(){Ark.ajax.post("/j/ebook/"+g+"/referral_code",function(r){j.val(r.referral_code);var q=location.href.split(/\?|#/)[0]+"?referral_code="+r.referral_code;p.val(q).on("mouseover click",function(){$(this).focus().select()});i.show();l.on("change",function(){i.toggle()});m.one("click",function(){h.show()})})}},a=function(h){var i=h.panel,f=i.find("textarea[name=text]"),e=i.find(".mention-highlighter"),j=i.find(".submit-share"),g=h.getConfig();d(i);if(!e.length){e=$("<div>",{"class":"mention-highlighter"});i.find(".share-text-wrapper").append(e)}j.submit(function(o){var l=j.attr("action"),k=$(this).serializeArray(),n={};$.each(k,function(q,r){n[r.name]=r.value});var p=b(e);if(p){n.text=p}var m=function(r){var q='<p class="dialog-shared-info">{{info}}</p>';return q.replace("{{info}}",r)};c.post(l,n,function(q){if(!q.error){return Ark.alert($.extend({},g,{content:m("推荐成功"),timeout:2000}))}Ark.alert($.extend({},g,{content:m(q.error)}))});return false});f.textbox({itemCount:6,dataUrl:"https://api.douban.com/shuo/in/complete?alt=xd&amp;callback=?",listTmpl:$("#tmpl-mention").html(),highlighter:e})};$(document).on("click","a[rel=dialog][data-href]",function(f){f.preventDefault();Ark.applyDialog($(f.target),a)})});