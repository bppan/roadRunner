(function(){$.suggests=function(options){function onKeyDown(e){switch(e.keyCode){case 9:case 27:hideTips();break;case 38:prevSelect();break;case 40:nextSelect();break;case 13:selectCurrent(),form.submit();break;default:return}e.stopImmediatePropagation(),e.preventDefault()}function onKeyUp(e){switch(e.keyCode){case 38:case 40:return}currentQuery!==input.val()&&getData()}function getCurrentSelect(){if(suggestList.is(":hidden"))return!1;var currentSelect=suggestList.children("li."+options.selectClass);return currentSelect.length||(currentSelect=!1),currentSelect}function selectCurrent(){var currentSelect=getCurrentSelect();currentSelect&&(input.val(currentSelect.html()),hideTips(),input.blur())}function nextSelect(){var currentSelect=getCurrentSelect();currentSelect?currentSelect.removeClass(options.selectClass).next().addClass(options.selectClass):suggestList.children("li:first-child").addClass(options.selectClass)}function prevSelect(){var currentResult=getCurrentSelect();currentResult?currentResult.removeClass(options.selectClass).prev().addClass(options.selectClass):suggestList.children("li:last-child").addClass(options.selectClass)}function getData(){currentQuery=input.val(),""!==currentQuery?(clearTimeout(this._queryRef),this._queryRef=setTimeout(function(){$.ajax({type:"GET",url:options.url,data:options.param+"="+encodeURIComponent(currentQuery),success:function(data){makeList(data)},dataType:"json"})},options.delay)):hideTips()}function initTips(){suggestList.find("li").hover(function(){$(this).siblings("."+options.selectClass).removeClass(options.selectClass),$(this).addClass(options.selectClass)},function(){$(this).removeClass(options.selectClass)}).click(function(){selectCurrent(),form.submit()})}function showTips(html){suggestList.html(html);var offset=input.offset(),height=input.outerHeight();suggestList.css("top",offset.top+height),suggestList.css("left",offset.left),initTips(),suggestList.width(options.width),suggestList.show()}function hideTips(){suggestList.hide()}function makeList(json){for(var text,suggestsList=json.suggests,html="",max_lenth=26,i=0;suggestsList.length>i;i++)text=suggestsList[i],text&&text.length>max_lenth&&(text=text.substring(0,max_lenth)+"..."),html+=Ark.template(tmplSuggestItem,{suggest:text});suggestsList.length>0?showTips(html):hideTips()}var input=($(document.body),window._,$("#input-query")),form=$("#frm-search"),suggestList=$("#suggest-list"),tmplSuggestItem=$("#tmpl-suggest-item").html(),currentQuery=input.val(),defaults={url:"",param:"q",width:360,selectClass:"suggest-item-hover",delay:200};options=$.extend({},defaults,options),input.focus(function(){getData()}),input.blur(function(){setTimeout(function(){hideTips()},300)}),input.keydown(onKeyDown),input.keyup(onKeyUp),form.on("submit",function(e){input.val()||e.preventDefault()})},$.suggests({url:"/j/suggest",param:"q",width:423,delay:200})})();