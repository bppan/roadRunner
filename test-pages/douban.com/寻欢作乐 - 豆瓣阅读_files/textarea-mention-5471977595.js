Array.prototype.indexOf=Array.prototype.indexOf||function(item){for(var index=-1,i=0,len=this.length;len>i;i++)if(this[i]===item)return i;return index},function($){var pre,oSuggestList,txtMax=140,activeIdx=0,itemsSize=0,reqLimit=10,userFlag="",mentionUsers=[],wordsForSearch="",TMPL_SUGGEST_OVERLAY='<div id="{ID}" class="suggest-overlay"></div>',oBody=$(document.body),reg_space=/ /g,reg_btag=/<\/?b>/g,ua=navigator.userAgent,isIE=/msie/i.test(ua),isMozilla=/mozilla/i.test(ua),ieVersion=isIE&&+/msie (\d+)/i.exec(ua)[1],blankChar=7>ieVersion?"&nbsp;":"x",ltIE9=9>ieVersion,methods={getCarePos:function(node,con){var dot=$("<em>&nbsp;</em>"),node=$(node),nodePos=node.offset(),pos={};return pre||(pre=$('<pre class="mention-pre"></pre>').css(this.initPreStyle(node)),pre.appendTo("body")),ltIE9&&(con=con.replace(reg_space,blankChar)),pre.html(con).append(dot),pos=dot.position(),{left:pos.left+nodePos.left+2,top:pos.top+nodePos.top+21}},initPreStyle:function(node){return{position:"absolute",left:-9999,width:node.width()+"px","font-family":node.css("font-family"),"font-size":node.css("font-size"),"word-wrap":"break-word",border:"1px"}},highlightName:function(data,txt){return $.each(data,function(i,v){ltIE9&&(v=v.replace(reg_space,"&nbsp;")),userFlag=v.split(":"),txt=txt.replace(RegExp("@"+userFlag[1],"g"),'<code data-id="'+userFlag[0]+'">@'+userFlag[1]+"</code>")}),txt},updateHighlight:function(hi,data,txt){ltIE9&&(txt=txt.replace(reg_space,blankChar)),$(hi).html(this.highlightName(data,txt))},moveSelectedItem:function(step){var items=oSuggestList.find("li");activeIdx=oSuggestList.find(".on").index(),itemsSize&&(activeIdx+=step,activeIdx>=itemsSize&&(activeIdx-=itemsSize),0>activeIdx&&(-2===activeIdx&&(activeIdx=-1),activeIdx+=itemsSize),items.removeClass("on"),$(items[activeIdx]).addClass("on"))},getCursorPosition:function(t){if(document.selection){t.focus();var ds=document.selection,range=ds.createRange(),storedRange=range.duplicate();return storedRange.moveToElementText(t),storedRange.setEndPoint("EndToEnd",range),t.selectionStart=storedRange.text.length-range.text.length,t.selectionEnd=t.selectionStart+range.text.length,t.selectionStart}return t.selectionStart},setCursorPosition:function(t,p){this.selectRangeText(t,p,p)},selectRangeText:function(t,s,z){if(document.selection){var range=t.createTextRange();range.moveEnd("character",-t.value.length),range.moveEnd("character",z),range.moveStart("character",s),range.select()}else t.setSelectionRange(s,z),t.focus()},deleteRangeText:function(t,n){var p=this.getCursorPosition(t),s=t.scrollTop,val=t.value;t.value=n>0?val.slice(0,p-n)+val.slice(p):val.slice(0,p)+val.slice(p-n),this.setCursorPosition(t,p-(0>n?0:n)),firefox=isMozilla&&setTimeout(function(){t.scrollTop!==s&&(t.scrollTop=s)},10)},insertAfterCursor:function(t,txt,hl){if(t.value,document.selection)t.focus(),document.selection.createRange().text=txt+" ",this.updateHighlight(hl,mentionUsers,t.value);else{var cp=t.selectionStart,ubbLength=t.value.length,s=t.scrollTop;t.value=t.value.slice(0,cp)+txt+t.value.slice(cp,ubbLength)+" ",this.updateHighlight(hl,mentionUsers,t.value),this.setCursorPosition(t,cp+txt.length+1),firefox=isMozilla&&setTimeout(function(){t.scrollTop!==s&&(t.scrollTop=s)},0)}}};$.fn.textbox=function(opts){var defaults={mode:"complete",itemCount:10,customData:null,highlighter:".highlighter",tips:"@某人,&nbsp;他能收到你的消息"},options=$.extend(defaults,opts),self=this,canMention=!0,canSetPos=!1,actionComplete=function(obj,hl){var that=(obj.value,oSuggestList.find(".on")),uid=that.attr("data-id")||that.attr("id")||"",screenName=$.trim(that.text().split("(")[0]),store_key=(uid+":"+screenName).replace(reg_btag,"");-1==mentionUsers.indexOf(store_key)&&mentionUsers.push(store_key),methods.deleteRangeText(obj,wordsForSearch.length),methods.insertAfterCursor(obj,screenName,hl),options.onMention&&options.onMention.call(self,uid,screenName,mentionUsers),"undefined"!=typeof App&&"complete"===options.mode&&App.Widgets.StatusBox.updateNum(txtMax-$.trim(obj.value).length),oSuggestList.hide()},clearSuggestList=function(){oSuggestList.html('<div class="bd">'+options.tips+"</div>")},getFollowingList=function(obj,preChar,offset){var val=obj.value,lastCharAt=val.substring(0,offset).lastIndexOf("@"),hasSpace=val.substring(lastCharAt,offset).indexOf(" "),pos={};wordsForSearch=val.substring(lastCharAt+1,offset);var customData=options.customData,mode=options.mode,itemCount=options.itemCount,listTmpl=options.listTmpl;if("complete"!==mode?showFixedSuggestList(obj):"@"===preChar&&(pos=methods.getCarePos(obj,val.substring(0,offset-1)),showSuggestList(obj,pos)),-1===lastCharAt||-1!==hasSpace)return oSuggestList&&oSuggestList.hide();if(!(wordsForSearch.length>reqLimit)){if("complete"===mode&&(pos=methods.getCarePos(obj,val.substring(0,lastCharAt))),!wordsForSearch){var customData=customData&&customData(),users=customData&&customData.users;return users&&users.length?(itemsSize=users.length,oSuggestList.html(Ark.template(listTmpl,customData)),oSuggestList.children().click(function(){actionComplete(obj,highlighter)}),void 0):clearSuggestList()}$.getJSON(options.dataUrl,{count:itemCount,word:wordsForSearch},function(o){if(o&&o.users||(o={users:[]}),itemCount>o.users.length&&customData){var excludes={};$.each(o.users,function(i,item){excludes[item.uid]=1}),o.users=o.users.concat(customData(wordsForSearch,itemCount-o.users.length,excludes).users)}return o.users.length?(oSuggestList.get(0).innerHTML=Ark.template(listTmpl,o),oSuggestList.find("li").hasClass("on")||oSuggestList.find("li:first").attr("class","on"),itemsSize=oSuggestList.find("li").size(),"complete"===mode?showSuggestList(obj,pos):showFixedSuggestList(obj),void 0):oSuggestList.hide()})}},showSuggestList=function(obj,pos){$("#db-suggest-flist").remove(),oSuggestList=$("#db-suggest-list"),oSuggestList.length||(oSuggestList=$(TMPL_SUGGEST_OVERLAY.replace("{ID}","db-suggest-list")),oSuggestList.appendTo("body"));var node=$(obj);oSuggestList.css({marginLeft:node.css("paddingLeft"),marginTop:node.css("paddingTop"),top:pos.top+"px",left:pos.left+"px"}).show(),oSuggestList.children().click(function(){actionComplete(obj,options.highlighter)})},showFixedSuggestList=function(obj){$("#db-suggest-list").remove(),oSuggestList=$("#db-suggest-flist"),oSuggestList.length||(oSuggestList=$(TMPL_SUGGEST_OVERLAY.replace("{ID}","db-suggest-flist")),$(obj).before(oSuggestList[0]));var hasCmt=$(".comment-item").length;oSuggestList.css({left:0,top:hasCmt?"auto":"71px",bottom:hasCmt?"43px":"auto",width:"272px"}).show(),oSuggestList.children().click(function(){actionComplete(obj,options.highlighter)})};this.bind("keyup input propertychange",function(e){if(this._closed)return $(options.highlighter).html("");if("propertychange"!=e.type||"value"===e.originalEvent.propertyName){var is_change_events="input"==e.type||"propertychange"==e.type;if(this._from_change=is_change_events?!0:!1,!is_change_events||this._from_change){var elem=this,val=elem.value,oHighLighter=oHighLighter||$(options.highlighter),offset=methods.getCursorPosition(this),preChar=val.charAt(offset-1);val||oHighLighter.html(""),val.length+1>offset&&mentionUsers.length&&canMention&&(oHighLighter.css("marginTop",-elem.scrollTop),methods.updateHighlight(oHighLighter,mentionUsers,val)),38!==e.keyCode&&40!==e.keyCode&&13!==e.keyCode&&16!==e.keyCode&&9!==e.keyCode&&getFollowingList(this,preChar,offset),(9===e.keyCode||13===e.keyCode)&&oSuggestList&&oSuggestList.find(".on").size()&&oSuggestList.is(":visible")&&actionComplete(this,options.highlighter)}}}),this.bind("keydown",function(e){if(canMention=(e.ctrlKey||e.metaKey)&&65===e.keyCode||e.shiftKey&&(37===e.keyCode||39===e.keyCode)?!1:!0,oSuggestList&&oSuggestList.is(":visible")&&oSuggestList.find("ul").length)switch(e.keyCode){case 32:oSuggestList.hide();break;case 38:e.preventDefault(),methods.moveSelectedItem(-1);break;case 40:e.preventDefault(),methods.moveSelectedItem(1);break;case 8:var li=oSuggestList.find("li");if(1==li.length){var elem=this,val=elem.value,offset=methods.getCursorPosition(elem),anterior=val.slice(0,offset),pre=anterior.slice(0,anterior.lastIndexOf("@")),uname_on=$.trim(li.text().split("(")[0]),uname=anterior.slice(anterior.lastIndexOf("@")+1);uname==uname_on&&(val=elem.value=pre+val.slice(offset),methods.setCursorPosition(elem,offset-uname.length))}break;case 9:case 13:e.preventDefault();break;default:canSetPos=!1}}),oBody.delegate(".suggest-overlay li","hover",function(){$(this).parent().children(".on").removeClass().end().end().toggleClass("on")}),oBody.click(function(){oSuggestList&&oSuggestList.length&&oSuggestList.hide()}),this.bind("mention",function(e,uid,name,hl){var store_key=(uid+":"+name).replace(reg_btag,"");-1==mentionUsers.indexOf(store_key)&&mentionUsers.push(store_key),methods.insertAfterCursor(this,"@"+name,hl)})}}(jQuery);